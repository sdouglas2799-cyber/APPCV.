<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Registro de Trator</title>

  <!-- CONFIGURA√á√ÉO PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icone_192.png">
  <link rel="apple-touch-icon" href="icone_512.png">
  <meta name="theme-color" content="#007bff">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #000; padding: 6px; text-align: center; }
    button { cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
    #mensagem { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; text-align: center; display: none; }
    .sucesso { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .erro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .botoes-acoes { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .btn-apagar { background: #dc3545; }
    .btn-apagar:hover { background: #b02a37; }
  </style>
</head>
<body>

<h2>üöú Registro de Trator</h2>

<label>Data:</label>
<input type="date" id="data">

<label>Operador:</label>
<input type="text" id="operador" placeholder="Nome do operador">

<label>Associado:</label>
<input type="text" id="associado" placeholder="Nome do associado">

<label>Modelo do Trator:</label>
<input type="text" id="modelo" placeholder="Ex: Massey Ferguson 275">

<label>Atividade:</label>
<input type="text" id="atividade" placeholder="Ex: Aragem, transporte, pulveriza√ß√£o">

<label>Hor√≠metro Inicial:</label>
<input type="number" id="horimetroInicial" step="0.01" min="0">

<label>Hor√≠metro Final:</label>
<input type="number" id="horimetroFinal" step="0.01" min="0">

<div class="botoes-acoes">
  <button onclick="registrar()">Registrar</button>
  <button onclick="exportarCSV()">Exportar CSV</button>
  <button class="btn-apagar" onclick="limparTodos()">Apagar Tudo</button>
  <button onclick="sincronizarPendentes()">üîÑ Sincronizar Pendentes</button>
</div>

<div id="mensagem"></div>

<table id="tabela">
  <thead>
    <tr>
      <th>Data</th>
      <th>Operador</th>
      <th>Associado</th>
      <th>Modelo</th>
      <th>Atividade</th>
      <th>Hor√≠metro Inicial</th>
      <th>Hor√≠metro Final</th>
      <th>Horas Trabalhadas</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let registros = JSON.parse(localStorage.getItem("registrosTrator")) || [];
let pendentes = JSON.parse(localStorage.getItem("pendentesDeEnvio")) || [];

function salvarLocal() {
  localStorage.setItem("registrosTrator", JSON.stringify(registros));
}

function salvarPendentes() {
  localStorage.setItem("pendentesDeEnvio", JSON.stringify(pendentes));
}

function calcularHorasTrabalhadas(hIni, hFim) {
  let horas = hFim - hIni;
  return horas < 0 ? 0 : horas.toFixed(2);
}

function mostrarMensagem(texto, tipo) {
  const msg = document.getElementById("mensagem");
  msg.textContent = texto;
  msg.className = tipo;
  msg.style.display = "block";
  setTimeout(() => msg.style.display = "none", 4000);
}

async function enviarParaGoogleSheets(dados) {
  const url = "https://script.google.com/macros/s/AKfycbznwlGzG1-0lnV1810c4Vi5jlagHMRE1jpsSxNx56XBgc7u3QBbjbGozVnicawKuRMSsQ/exec";

  try {
    await fetch(url, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dados)
    });

    mostrarMensagem("‚úÖ Registro enviado ao Google Sheets!", "sucesso");

  } catch (erro) {
    console.warn("Sem internet ‚Äî salvando como pendente.");
    pendentes.push(dados);
    salvarPendentes();
    mostrarMensagem("‚ö†Ô∏è Sem internet! Registro salvo e ser√° sincronizado depois.", "erro");
  }
}

function registrar() {
  const novoRegistro = {
    data: document.getElementById("data").value,
    operador: document.getElementById("operador").value.trim(),
    associado: document.getElementById("associado").value.trim(),
    modelo: document.getElementById("modelo").value.trim(),
    atividade: document.getElementById("atividade").value.trim(),
    horimetroInicial: parseFloat(document.getElementById("horimetroInicial").value),
    horimetroFinal: parseFloat(document.getElementById("horimetroFinal").value)
  };

  if (!novoRegistro.data || !novoRegistro.operador || !novoRegistro.associado || isNaN(novoRegistro.horimetroInicial) || isNaN(novoRegistro.horimetroFinal)) {
    mostrarMensagem("‚ö†Ô∏è Preencha todos os campos corretamente!", "erro");
    return;
  }

  if (novoRegistro.horimetroFinal < novoRegistro.horimetroInicial) {
    mostrarMensagem("‚ö†Ô∏è O hor√≠metro final n√£o pode ser menor que o inicial!", "erro");
    return;
  }

  novoRegistro.horasTrabalhadas = calcularHorasTrabalhadas(novoRegistro.horimetroInicial, novoRegistro.horimetroFinal);

  registros.push(novoRegistro);
  salvarLocal();
  atualizarTabela();
  enviarParaGoogleSheets(novoRegistro);

  document.querySelectorAll("input").forEach(i => i.value = "");
  mostrarMensagem("‚úÖ Registro adicionado com sucesso!", "sucesso");
}

function atualizarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  registros.forEach((r, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.data}</td>
      <td>${r.operador}</td>
      <td>${r.associado}</td>
      <td>${r.modelo}</td>
      <td>${r.atividade}</td>
      <td>${r.horimetroInicial}</td>
      <td>${r.horimetroFinal}</td>
      <td>${r.horasTrabalhadas}</td>
      <td><button class="btn-apagar" onclick="apagarRegistro(${index})">üóëÔ∏è Apagar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function apagarRegistro(index) {
  if (confirm("Tem certeza que deseja apagar este registro?")) {
    registros.splice(index, 1);
    salvarLocal();
    atualizarTabela();
    mostrarMensagem("üóëÔ∏è Registro removido.", "sucesso");
  }
}

function limparTodos() {
  if (confirm("‚ö†Ô∏è Tem certeza que deseja apagar TODOS os registros?")) {
    registros = [];
    salvarLocal();
    atualizarTabela();
    mostrarMensagem("üßπ Todos os registros foram apagados.", "sucesso");
  }
}

function exportarCSV() {
  if (registros.length === 0) {
    mostrarMensagem("‚ö†Ô∏è Nenhum registro para exportar!", "erro");
    return;
  }

  let csv = "Data,Operador,Associado,Modelo,Atividade,Hor√≠metro Inicial,Hor√≠metro Final,Horas Trabalhadas\n";
  registros.forEach(r => {
    csv += `${r.data},${r.operador},${r.associado},${r.modelo},${r.atividade},${r.horimetroInicial},${r.horimetroFinal},${r.horasTrabalhadas}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "registros_trator.csv";
  link.click();
}

async function sincronizarPendentes() {
  if (pendentes.length === 0) {
    mostrarMensagem("Nenhum registro pendente para sincronizar.", "erro");
    return;
  }

  mostrarMensagem("‚è≥ Sincronizando...", "sucesso");

  const url = "https://script.google.com/macros/s/AKfycbznwlGzG1-0lnV1810c4Vi5jlagHMRE1jpsSxNx56XBgc7u3QBbjbGozVnicawKuRMSsQ/exec";

  let enviados = 0;

  for (let item of pendentes) {
    try {
      await fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(item)
      });

      enviados++;

    } catch (e) {
      mostrarMensagem("‚ùå Ainda sem internet. Tente novamente.", "erro");
      return;
    }
  }

  pendentes = [];
  salvarPendentes();
  mostrarMensagem(`‚úÖ ${enviados} registro(s) sincronizados!`, "sucesso");
}

atualizarTabela();
</script>

<!-- SERVICE WORKER -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.error("Erro ao registrar SW:", err));
}
</script>

</body>
</html>
